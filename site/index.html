<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="description"
        content="Icecast Metadata JS - Javascript library that reads, parses, and queues real-time metadata from an Icecast stream." />
    <script src="https://eshaz.github.io/icecast-metadata-js/icecast-metadata-player-1.11.6.min.js"></script>

</head>
<script>
    // helper functions for the demo
    let icecastMetadataPlayer, metadataEl, metadataQueueEl;

    const formatTime = (seconds) =>
        new Date(seconds * 1000).toISOString().substr(14, 8);

    const formatMetadata = (metadata) =>
        `${metadata.StreamTitle ? metadata.StreamTitle + " auf " : ''}${endpoint.selectedOptions[0].innerText}`

    const onMetadata = (metadata) => {
        metadataEl.innerHTML = `<td>${formatMetadata(metadata)}</td>`;
        onMetadataEnqueue();
    };

    const onMetadataEnqueue = () => {
        metadataQueueEl.innerHTML = icecastMetadataPlayer.metadataQueue.reduce(
            (acc, { metadata, timestampOffset }) =>
                acc +
                `<tr><td>${formatTime(timestampOffset)}</td>` +
                `<td>${formatMetadata(metadata)}</td></tr>`,
            `<th>Als nächstes</th>`
        );
    };
</script>

<body>


    <div class="row">

        <div class="options">
            <label for="endpoint">Radio Sender</label>
            <select class="stream-endpoint" name="endpoint" id="endpoint" type="url">
                <option value="https://icecast.radiobremen.de/rb/bremenvier/live/mp3/128/stream.mp3">Bremen Vier</option>
                <option value="https://live.wostreaming.net/direct/ppm-jazz24aac256-ibc1">Jazz 24</option>
            </select>
        </div>

        <audio id="audio" controls>
            Your browser does not support HTML5 audio.
        </audio>
    </div>
    <hr />
    <div class="metadata-info">
        <table>
            <th>Jetzt läuft</th>
            <tr id="metadata"></tr>
        </table>
        <table id="metadataQueue"></table>
    </div>

    <footer>
        We are using Node.js <span id="node-version"></span>,
        Chromium <span id="chrome-version"></span>,
        and Electron <span id="electron-version"></span>.
    </footer>

</body>
<script>
    const endpoint = document.getElementById("endpoint");
    const audioElement = document.getElementById("audio");
    metadataEl = document.getElementById("metadata");
    metadataQueueEl = document.getElementById("metadataQueue");

    const getIcecastMetadataPlayer = () => {
        icecastMetadataPlayer = new IcecastMetadataPlayer(endpoint.value, {
            audioElement, //                  audio element in HTML
            onMetadata, //                    called when metadata is synced with the audio
            onMetadataEnqueue, //             called when metadata is discovered in the stream
            metadataTypes: ["icy"], //        detect ICY metadata
            icyDetectionTimeout: 5000, //     attempt to detect ICY metadata for 5 seconds
            enableLogging: true, //           enable error logs to the console
            onError: (message) => {
                metadataEl.innerHTML = message;
            },
        });
    };

    getIcecastMetadataPlayer();

    endpoint.addEventListener("change", async () => {
        await icecastMetadataPlayer.detachAudioElement();
        getIcecastMetadataPlayer();
    });
</script>

<style>
    html {
        margin: 0;
        padding: 0;
        height: 100%;
        font: 1rem sans-serif;
        overflow-y: hidden;
    }

    footer {
        position: absolute;
        bottom: 0;
        width: 644px;
        height: 20px;
        margin: 0 auto;
    }

    body {
        margin: 0;
        padding: 3rem;
        height: 100%;
        font: 1rem sans-serif;
        overflow-y: hidden;
    }

</style>

</html>